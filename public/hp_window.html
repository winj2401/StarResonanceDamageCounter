<!doctype html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>è¡€æ¡ç›‘æ§ - æ˜Ÿç—•å…±é¸£</title>
        <script src="./socket.io.min.js"></script>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
                background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
                color: #ffffff;
                overflow: hidden;
                user-select: none;
            }

            .container {
                height: 100vh;
                display: flex;
                flex-direction: column;
            }

            .header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 6px 8px;
                background: rgba(0, 0, 0, 0.2);
                backdrop-filter: blur(10px);
            }

            .header-left {
                display: flex;
                flex-direction: column;
                align-items: flex-start;
                flex: 1;
            }

            .header-center {
                display: flex;
                gap: 6px;
                flex: 2;
                justify-content: center;
            }

            .header-right {
                display: flex;
                align-items: center;
                flex: 1;
                justify-content: flex-end;
            }

            .title {
                font-size: 16px;
                font-weight: 600;
                margin-bottom: 1px;
                text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            }

            .subtitle {
                font-size: 11px;
                opacity: 0.8;
            }

            .controls {
                display: flex;
                gap: 6px;
            }

            .btn {
                padding: 4px 8px;
                font-size: 11px;
                border: none;
                border-radius: 4px;
                background: rgba(255, 255, 255, 0.2);
                color: white;
                cursor: pointer;
                transition: all 0.3s ease;
                backdrop-filter: blur(10px);
            }

            .btn:hover {
                background: rgba(255, 255, 255, 0.3);
                transform: translateY(-1px);
            }

            .btn.active {
                background: #4caf50;
                box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
            }

            .hp-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                grid-auto-rows: 45px;
                flex: 1;
                overflow-y: auto;
                align-content: start;
            }

            /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
            .hp-grid::-webkit-scrollbar {
                width: 6px;
            }

            .hp-grid::-webkit-scrollbar-track {
                background: rgba(255, 255, 255, 0.1);
                border-radius: 3px;
            }

            .hp-grid::-webkit-scrollbar-thumb {
                background: rgba(255, 255, 255, 0.3);
                border-radius: 3px;
            }

            .hp-grid::-webkit-scrollbar-thumb:hover {
                background: rgba(255, 255, 255, 0.5);
            }

            .player-card {
                background: rgba(0, 0, 0, 0.25);
                border-radius: 8px;
                padding: 6px;
                backdrop-filter: blur(15px);
                border: 1px solid rgba(255, 255, 255, 0.1);
                transition: all 0.3s ease;
                position: relative;
                overflow: hidden;
                height: 45px;
                display: flex;
                flex-direction: column;
                justify-content: space-between;
            }

            .player-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
                border-color: rgba(255, 255, 255, 0.2);
            }

            .player-card::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                height: 2px;
                background: var(--profession-color, #4caf50);
                opacity: 0.8;
            }

            .player-info {
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                margin-bottom: 4px;
                flex-wrap: wrap;
                gap: 4px;
            }

            .player-basic {
                display: flex;
                align-items: center;
                gap: 6px;
                flex: 1;
                min-width: 0;
            }

            .player-name {
                font-size: 12px;
                font-weight: 600;
                color: #ffffff;
                text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                min-width: 0;
            }

            .player-profession {
                font-size: 9px;
                padding: 1px 4px;
                border-radius: 8px;
                background: var(--profession-color, #4caf50);
                color: white;
                font-weight: 500;
                white-space: nowrap;
            }

            .player-stats {
                display: flex;
                gap: 8px;
                font-size: 9px;
                opacity: 0.9;
                align-items: center;
            }

            .hp-container {
                margin-bottom: 0;
                position: relative;
            }

            .hp-text {
                display: flex;
                justify-content: space-between;
                align-items: center;
                font-size: 10px;
                position: absolute;
                left: 0;
                right: 0;
                top: 50%;
                transform: translateY(-50%);
                z-index: 2;
                pointer-events: none;
            }

            .hp-current {
                font-weight: 600;
                color: #ffffff;
                text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
                margin-left: 4px;
            }

            .hp-max {
                color: #ffffff;
                opacity: 0.9;
                text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
                margin-right: 4px;
            }

            .hp-percentage {
                color: #ffffff;
                font-weight: 600;
                text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
            }

            .hp-bar {
                height: 14px;
                background: rgba(255, 255, 255, 0.1);
                border-radius: 3px;
                overflow: hidden;
                position: relative;
            }

            .hp-fill {
                height: 100%;
                background: linear-gradient(90deg, var(--hp-color, #4caf50) 0%, var(--hp-color-light, #66bb6a) 100%);
                border-radius: 3px;
                transition:
                    width 0.5s ease,
                    background-color 0.3s ease;
                position: relative;
            }

            .hp-bar::after {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: linear-gradient(90deg, transparent 0%, rgba(255, 255, 255, 0.2) 50%, transparent 100%);
                animation: shine 6s infinite;
            }

            @keyframes shine {
                0% {
                    transform: translateX(-100%);
                }
                100% {
                    transform: translateX(100%);
                }
            }

            .stat-item {
                display: flex;
                align-items: center;
                gap: 2px;
                font-weight: 500;
                color: rgba(255, 255, 255, 0.9);
            }

            .stat-icon {
                font-size: 8px;
                opacity: 0.8;
            }

            .stat-value {
                font-size: 9px;
                font-weight: 600;
            }

            /* è¡€é‡çŠ¶æ€é¢œè‰² */
            .hp-critical {
                --hp-color: #f44336;
                --hp-color-light: #ef5350;
            }

            .hp-warning {
                --hp-color: #ff9800;
                --hp-color-light: #ffb74d;
            }

            .hp-healthy {
                --hp-color: #4caf50;
                --hp-color-light: #66bb6a;
            }

            .hp-full {
                --hp-color: #2196f3;
                --hp-color-light: #42a5f5;
            }

            /* èŒä¸šé¢œè‰² */
            .profession-damage {
                --profession-color: #f44336;
            }
            .profession-tank {
                --profession-color: #2196f3;
            }
            .profession-heal {
                --profession-color: #4caf50;
            }
            .profession-support {
                --profession-color: #ff9800;
            }
            .profession-unknown {
                --profession-color: #9e9e9e;
            }

            .no-data {
                grid-column: 1 / -1;
                text-align: center;
                padding: 40px;
                opacity: 0.6;
                font-size: 14px;
            }

            .connection-status {
                padding: 4px 8px;
                border-radius: 12px;
                font-size: 10px;
                font-weight: 600;
                backdrop-filter: blur(10px);
                transition: all 0.3s ease;
                white-space: nowrap;
            }

            .status-connected {
                background: rgba(76, 175, 80, 0.8);
                color: white;
            }

            .status-disconnected {
                background: rgba(244, 67, 54, 0.8);
                color: white;
            }

            .status-connecting {
                background: rgba(255, 152, 0, 0.8);
                color: white;
            }

            /* å“åº”å¼å¸ƒå±€ - å°å±å¹•ä¼˜åŒ– */
            @media (max-width: 600px) {
                .header {
                    flex-direction: column;
                    text-align: center;
                }

                .header-left,
                .header-center,
                .header-right {
                    flex: none;
                    width: 100%;
                    justify-content: center;
                }

                .header-left {
                    align-items: center;
                }

                .player-card {
                    padding: 6px;
                }

                .player-stats {
                    gap: 6px;
                }

                .player-name {
                    font-size: 11px;
                }
            }

            /* çª„å±æ¨¡å¼ï¼šåªæ˜¾ç¤ºæ§åˆ¶æŒ‰é’® */
            @media (max-width: 700px) {
                .header {
                    flex-direction: row;
                    justify-content: center;
                    gap: 0;
                    padding: 4px 6px;
                }

                .header-left,
                .header-right {
                    display: none;
                }

                .header-center {
                    flex: 1;
                    width: auto;
                }

                .controls {
                    gap: 3px;
                }

                .btn {
                    font-size: 9px;
                    padding: 3px 5px;
                }
            }

            /* æçª„å±æ¨¡å¼ï¼šéšè—DPSç­‰æ•°æ® */
            @media (max-width: 400px) {
                /* éšè—ç©å®¶ç»Ÿè®¡æ•°æ® */
                .player-stats {
                    display: none;
                }
            }

            /* æçª„å±æ¨¡å¼ï¼šéšè—å¤´éƒ¨ */
            @media (max-width: 300px) {
                .header {
                    display: none;
                }
            }

            /* åŠ¨æ€è¿›å…¥åŠ¨ç”» */
            .player-card {
                animation: slideInUp 0.6s ease-out;
                transition:
                    all 0.3s ease,
                    opacity 0.2s ease;
            }

            .player-card:nth-child(even) {
                animation-delay: 0.1s;
            }

            /* éšè—çŠ¶æ€çš„å¹³æ»‘è¿‡æ¸¡ */
            .player-card[style*='display: none'] {
                opacity: 0;
                transform: translateY(-10px);
            }

            @keyframes slideInUp {
                from {
                    opacity: 0;
                    transform: translateY(20px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            /* ä½è¡€é‡é—ªçƒæ•ˆæœ */
            .hp-critical .player-card {
                animation: pulse 2s infinite;
            }

            @keyframes pulse {
                0%,
                100% {
                    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
                }
                50% {
                    box-shadow: 0 8px 20px rgba(244, 67, 54, 0.4);
                }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <div class="header-left">
                    <div class="title">ğŸ©¸ è¡€æ¡ç›‘æ§</div>
                    <div class="subtitle" id="playerCount">ç­‰å¾…æ•°æ®è¿æ¥...</div>
                </div>

                <div class="header-center">
                    <div class="controls">
                        <button class="btn active" id="sortHpBtn" onclick="setSortMode('hp')">ğŸ’š æŒ‰è¡€é‡</button>
                        <button class="btn" id="sortNameBtn" onclick="setSortMode('name')">ğŸ·ï¸ æŒ‰å§“å</button>
                        <button class="btn" id="sortDpsBtn" onclick="setSortMode('dps')">âš”ï¸ æŒ‰DPS</button>
                        <button class="btn" id="sortHpsBtn" onclick="setSortMode('hps')">ğŸ©¹ æŒ‰HPS</button>
                    </div>
                </div>

                <div class="header-right">
                    <div class="connection-status status-connecting" id="connectionStatus">ğŸ”„ è¿æ¥ä¸­</div>
                </div>
            </div>

            <div class="hp-grid" id="playerGrid">
                <div class="no-data">
                    <div>ğŸ”„ æ­£åœ¨è¿æ¥æœåŠ¡å™¨...</div>
                </div>
            </div>
        </div>

        <script>
            // å…¨å±€å˜é‡
            let socket = null;
            let isWebSocketConnected = false;
            let apiInterval = null;
            let isPaused = false;
            let currentSortMode = 'hp';
            let currentPlayers = [];
            let playerCards = []; // é¢„ç”Ÿæˆçš„å¡ç‰‡æ•°ç»„
            const MAX_CARDS = 20; // æœ€å¤§å¡ç‰‡æ•°é‡

            // èŒä¸šæ˜ å°„
            const professionMap = {
                é›·å½±å‰‘å£«: { type: 'damage', color: '#e74c3c', short_name: 'å¤ªåˆ€' },
                å†°é­”å¯¼å¸ˆ: { type: 'damage', color: '#e74c3c', short_name: 'å†°æ³•' },
                é’å²šéª‘å£«: { type: 'damage', color: '#e74c3c', short_name: 'é•¿æª' },
                ç¥å°„æ‰‹: { type: 'damage', color: '#e74c3c', short_name: 'å¼“ç®­' },
                'æ¶¤ç½ªæ¶ç«Â·æˆ˜æ–§': { type: 'damage', color: '#e74c3c', short_name: 'æˆ˜æ–§' },
                'é›·éœ†ä¸€é—ªÂ·æ‰‹ç‚®': { type: 'damage', color: '#e74c3c', short_name: 'æ‰‹ç‚®' },
                'æš—çµç¥ˆèˆÂ·ä»ªåˆ€/ä»ªä»—': { type: 'damage', color: '#e74c3c', short_name: 'ä»ªåˆ€' },
                æ£®è¯­è€…: { type: 'heal', color: '#27ae60', short_name: 'æ£®è¯­' },
                çµé­‚ä¹æ‰‹: { type: 'heal', color: '#27ae60', short_name: 'å‰ä»–' },
                å·¨åˆƒå®ˆæŠ¤è€…: { type: 'tank', color: '#2980b9', short_name: 'å·¨åˆƒ' },
                ç¥ç›¾éª‘å£«: { type: 'tank', color: '#2980b9', short_name: 'å‰‘ç›¾' },
            };

            // åˆå§‹åŒ–è¿æ¥
            function initConnection() {
                initWebSocket();
                monitorConnection();
            }

            // WebSocketè¿æ¥
            function initWebSocket() {
                try {
                    socket = io();

                    socket.on('connect', () => {
                        console.log('WebSocket è¿æ¥æˆåŠŸ');
                        isWebSocketConnected = true;
                        stopAPIFallback();
                        updateConnectionStatus('connected');
                    });

                    socket.on('data', (data) => {
                        if (!isPaused && data && data.user) {
                            processData(data.user);
                        }
                    });

                    socket.on('disconnect', () => {
                        console.log('WebSocket è¿æ¥æ–­å¼€');
                        isWebSocketConnected = false;
                        updateConnectionStatus('disconnected');
                    });

                    socket.on('connect_error', (error) => {
                        console.error('WebSocket è¿æ¥é”™è¯¯:', error);
                        isWebSocketConnected = false;
                        updateConnectionStatus('disconnected');
                    });
                } catch (error) {
                    console.error('WebSocket åˆå§‹åŒ–å¤±è´¥:', error);
                    startAPIFallback();
                }
            }

            // ç›‘æ§è¿æ¥çŠ¶æ€
            function monitorConnection() {
                setInterval(() => {
                    if (!isWebSocketConnected && !apiInterval) {
                        console.log('WebSocket æ–­å¼€ï¼Œåˆ‡æ¢åˆ° API è½®è¯¢');
                        startAPIFallback();
                    }
                }, 3000);
            }

            // å¯åŠ¨APIå¤‡ç”¨æ¨¡å¼
            function startAPIFallback() {
                if (apiInterval) return;

                console.log('å¯åŠ¨APIè½®è¯¢æ¨¡å¼');
                updateConnectionStatus('api');
                apiInterval = setInterval(fetchDataFromAPI, 100);
            }

            // åœæ­¢APIå¤‡ç”¨æ¨¡å¼
            function stopAPIFallback() {
                if (apiInterval) {
                    clearInterval(apiInterval);
                    apiInterval = null;
                    console.log('åœæ­¢APIè½®è¯¢æ¨¡å¼');
                }
            }

            // ä»APIè·å–æ•°æ®
            async function fetchDataFromAPI() {
                if (isPaused) return;

                try {
                    const response = await fetch('/api/data');
                    const data = await response.json();
                    if (data.code === 0 && data.user) {
                        processData(data.user);
                    }
                } catch (error) {
                    console.error('APIè¯·æ±‚å¤±è´¥:', error);
                    updateConnectionStatus('disconnected');
                }
            }

            // æ›´æ–°è¿æ¥çŠ¶æ€æ˜¾ç¤º
            function updateConnectionStatus(status) {
                const statusElement = document.getElementById('connectionStatus');
                statusElement.className = `connection-status status-${status}`;

                switch (status) {
                    case 'connected':
                        statusElement.textContent = 'ğŸŸ¢ WebSocket';
                        break;
                    case 'api':
                        statusElement.textContent = 'ğŸŸ¡ è½®è¯¢æ¨¡å¼';
                        break;
                    case 'disconnected':
                        statusElement.textContent = 'ğŸ”´ è¿æ¥æ–­å¼€';
                        break;
                    default:
                        statusElement.textContent = 'ğŸ”„ è¿æ¥ä¸­';
                }
            }

            // åˆ¤æ–­è§’è‰²æ˜¯å¦æœªå‚ä¸æˆ˜æ–—
            function isUserInactive(user) {
                // æ£€æŸ¥æ€»ä¼¤å®³ã€æ€»DPSã€æ€»HPSæ˜¯å¦éƒ½ä¸º0
                const totalDamage = user.total_damage?.total || 0;
                const totalDps = user.total_dps || 0;
                const totalHps = user.total_hps || 0;

                // æ£€æŸ¥æš´å‡»ç‡å’Œå¹¸è¿ç‡æ˜¯å¦ä¸ºNaN
                const critRate = user.total_count?.critical / user.total_count?.total;
                const luckyRate = user.total_count?.lucky / user.total_count?.total;

                return (totalDamage === 0 && totalDps === 0 && totalHps === 0) || (isNaN(critRate) && isNaN(luckyRate));
            }

            // å¤„ç†æ•°æ®
            function processData(users) {
                users = Object.entries(users)
                    .map(([id, user]) => ({ ...user, id }))
                    .filter((user) => !isUserInactive(user));
                if (!Array.isArray(users)) return;

                // è¿‡æ»¤å‡ºæœ‰è¡€é‡æ•°æ®çš„ç”¨æˆ·ï¼Œæœ€å¤š20ä¸ª
                let validUsers = users.filter((user) => user.hp !== undefined && user.max_hp !== undefined && user.max_hp > 0).slice(0, 20);

                // æ’åº
                validUsers = sortPlayers(validUsers);

                currentPlayers = validUsers;
                updateUI();
            }

            // æ’åºç©å®¶
            function sortPlayers(players) {
                switch (currentSortMode) {
                    case 'hp':
                        return players.sort((a, b) => {
                            const hpPercentA = (a.hp / a.max_hp) * 100;
                            const hpPercentB = (b.hp / b.max_hp) * 100;
                            return hpPercentA - hpPercentB; // è¡€é‡ä½çš„åœ¨å‰
                        });
                    case 'name':
                        return players.sort((a, b) => {
                            const nameA = (a.name || `UID:${a.id}`).toLowerCase();
                            const nameB = (b.name || `UID:${b.id}`).toLowerCase();
                            return nameA.localeCompare(nameB);
                        });
                    case 'dps':
                        return players.sort((a, b) => (b.total_dps || 0) - (a.total_dps || 0));
                    case 'hps':
                        return players.sort((a, b) => (b.total_hps || 0) - (a.total_hps || 0));
                    default:
                        return players;
                }
            }

            // æ›´æ–°UI
            function updateUI() {
                updatePlayerCount();
                renderPlayerCards();
            }

            // æ›´æ–°ç©å®¶æ•°é‡æ˜¾ç¤º
            function updatePlayerCount() {
                const playerCountElement = document.getElementById('playerCount');
                const count = currentPlayers.length;
                playerCountElement.textContent = `ç›‘æ§ä¸­: ${count}/20 åç©å®¶`;
            }

            // æ¸²æŸ“ç©å®¶å¡ç‰‡
            function renderPlayerCards() {
                const grid = document.getElementById('playerGrid');
                const noDataElement = grid.querySelector('.no-data');

                if (currentPlayers.length === 0) {
                    // éšè—æ‰€æœ‰å¡ç‰‡
                    playerCards.forEach((card, index) => {
                        setTimeout(() => {
                            card.style.display = 'none';
                        }, index * 20);
                    });

                    // æ˜¾ç¤ºæ— æ•°æ®æç¤º
                    if (noDataElement) {
                        setTimeout(
                            () => {
                                noDataElement.style.display = 'block';
                            },
                            playerCards.length * 20 + 100,
                        );
                    }
                    return;
                }

                // éšè—æ— æ•°æ®æç¤º
                if (noDataElement) {
                    noDataElement.style.display = 'none';
                }

                // æ›´æ–°ç°æœ‰å¡ç‰‡å†…å®¹å¹¶æ˜¾ç¤º
                currentPlayers.forEach((player, index) => {
                    if (index < playerCards.length) {
                        const card = playerCards[index];

                        // å¦‚æœå¡ç‰‡å½“å‰éšè—ï¼Œå…ˆæ˜¾ç¤ºå†æ›´æ–°å†…å®¹
                        if (card.style.display === 'none') {
                            card.style.display = 'flex';
                            card.style.opacity = '0';
                            card.style.transform = 'translateY(20px)';

                            // å»¶è¿Ÿæ˜¾ç¤ºåŠ¨ç”»
                            setTimeout(() => {
                                card.style.opacity = '1';
                                card.style.transform = 'translateY(0)';
                            }, index * 50);
                        }

                        updatePlayerCard(card, player, index);
                    }
                });

                // éšè—å¤šä½™çš„å¡ç‰‡
                for (let i = currentPlayers.length; i < playerCards.length; i++) {
                    const card = playerCards[i];
                    if (card.style.display !== 'none') {
                        card.style.opacity = '0';
                        card.style.transform = 'translateY(-10px)';

                        setTimeout(() => {
                            card.style.display = 'none';
                        }, 200);
                    }
                }
            }

            // é¢„ç”Ÿæˆç©å®¶å¡ç‰‡
            function preGeneratePlayerCards() {
                const grid = document.getElementById('playerGrid');

                // æ¸…ç©ºç°æœ‰å†…å®¹
                grid.innerHTML = '';
                playerCards = [];

                // åˆ›å»ºæœ€å¤§æ•°é‡çš„å¡ç‰‡
                for (let i = 0; i < MAX_CARDS; i++) {
                    const card = createEmptyPlayerCard(i);
                    playerCards.push(card);
                    grid.appendChild(card);
                }

                // æ·»åŠ æ— æ•°æ®æç¤ºå…ƒç´ 
                const noDataElement = document.createElement('div');
                noDataElement.className = 'no-data';
                noDataElement.innerHTML = '<div>ğŸ“­ æš‚æ— å‚æˆ˜ç©å®¶è¡€æ¡æ•°æ®<br>ğŸ—ºï¸ åˆ‡çº¿æˆ–åˆ‡å›¾å¯é‡æ–°è·å–è¡€æ¡æ•°æ®</div>';
                noDataElement.style.display = 'block';
                grid.appendChild(noDataElement);
            }

            // åˆ›å»ºç©ºçš„ç©å®¶å¡ç‰‡
            function createEmptyPlayerCard(index) {
                const div = document.createElement('div');
                div.className = 'player-card';
                div.style.animationDelay = `${index * 0.05}s`;
                div.style.display = 'none';
                div.style.opacity = '0';
                div.style.transform = 'translateY(20px)';

                div.innerHTML = `
                    <div class="player-info">
                        <div class="player-basic">
                            <div class="player-name" title="">ç­‰å¾…æ•°æ®...</div>
                            <div class="player-profession">-</div>
                        </div>
                        <div class="player-stats">
                            <div class="stat-item" title="æ€»DPS">
                                <span class="stat-icon">âš”ï¸</span>
                                <span class="stat-value">0</span>
                            </div>
                            <div class="stat-item" title="æ€»HPS">
                                <span class="stat-icon">ğŸ©¹</span>
                                <span class="stat-value">0</span>
                            </div>
                            <div class="stat-item" title="æ€»ä¼¤å®³">
                                <span class="stat-icon">ğŸ’¥</span>
                                <span class="stat-value">0</span>
                            </div>
                            <div class="stat-item" title="æ€»æ²»ç–—">
                                <span class="stat-icon">â¤ï¸</span>
                                <span class="stat-value">0</span>
                            </div>
                        </div>
                    </div>
                    <div class="hp-container">
                        <div class="hp-bar">
                            <div class="hp-fill" style="width: 0%"></div>
                        </div>
                        <div class="hp-text">
                            <span class="hp-current">0</span>
                            <span class="hp-percentage">0%</span>
                            <span class="hp-max">0</span>
                        </div>
                    </div>
                `;

                return div;
            }

            // æ›´æ–°ç°æœ‰ç©å®¶å¡ç‰‡
            function updatePlayerCard(cardElement, player, index) {
                const hp = player.hp || 0;
                const maxHp = player.max_hp || 1;
                const hpPercent = Math.max(0, Math.min(100, (hp / maxHp) * 100));
                const name = player.name || `UID:${player.id}`;
                const profession = player.profession || 'æœªçŸ¥';

                // è·å–èŒä¸šä¿¡æ¯
                const professionParts = profession.split('-');
                const mainProfession = professionParts[0];
                const subProfession = professionParts[1] || '';
                const professionInfo = professionMap[mainProfession] || { type: 'æœªçŸ¥', color: '#9E9E9E' };

                // ç¡®å®šè¡€é‡çŠ¶æ€
                let hpClass = '';
                if (hpPercent <= 25) hpClass = 'hp-critical';
                else if (hpPercent <= 50) hpClass = 'hp-warning';
                else if (hpPercent >= 99) hpClass = 'hp-full';
                else hpClass = 'hp-healthy';

                // æ›´æ–°å¡ç‰‡ç±»åå’Œæ ·å¼
                cardElement.className = `player-card profession-${professionInfo.type} ${hpClass}`;
                cardElement.style.setProperty('--profession-color', professionInfo.color);

                // æ›´æ–°å¡ç‰‡å†…å®¹
                const playerNameEl = cardElement.querySelector('.player-name');
                const playerProfessionEl = cardElement.querySelector('.player-profession');
                const hpCurrentEl = cardElement.querySelector('.hp-current');
                const hpPercentageEl = cardElement.querySelector('.hp-percentage');
                const hpMaxEl = cardElement.querySelector('.hp-max');
                const hpFillEl = cardElement.querySelector('.hp-fill');
                const statValues = cardElement.querySelectorAll('.stat-value');

                playerNameEl.textContent = name;
                playerNameEl.title = name;

                playerProfessionEl.textContent = subProfession || professionInfo.short_name || 'æœªçŸ¥';
                playerProfessionEl.style.backgroundColor = professionInfo.color;

                hpCurrentEl.textContent = hp;
                hpPercentageEl.textContent = `${hpPercent.toFixed(0)}%`;
                hpMaxEl.textContent = maxHp;
                hpFillEl.style.width = `${hpPercent}%`;

                // æ›´æ–°ç»Ÿè®¡æ•°æ®
                if (statValues.length >= 3) {
                    statValues[0].textContent = formatNumber(player.total_dps || 0, 1);
                    statValues[1].textContent = formatNumber(player.total_hps || 0, 1);
                    statValues[2].textContent = formatNumber(player.total_damage?.total || 0);
                    statValues[3].textContent = formatNumber(player.total_healing?.total || 0);
                }
            }

            // æ ¼å¼åŒ–æ•°å­—
            function formatNumber(num, decimals = 0) {
                if (num === undefined || num === null) return '0';

                const number = parseFloat(num);
                if (isNaN(number)) return '0';

                if (number >= 1000000) {
                    return (number / 1000000).toFixed(decimals) + 'M';
                } else if (number >= 1000) {
                    return (number / 1000).toFixed(decimals) + 'K';
                } else {
                    return number.toFixed(decimals);
                }
            }

            // è®¾ç½®æ’åºæ¨¡å¼
            function setSortMode(mode) {
                currentSortMode = mode;

                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                document.querySelectorAll('.controls .btn').forEach((btn) => {
                    btn.classList.remove('active');
                });
                const targetBtn = document.getElementById(`sort${mode.charAt(0).toUpperCase() + mode.slice(1)}Btn`);
                if (targetBtn) {
                    targetBtn.classList.add('active');
                }

                // é‡æ–°æ’åºå’Œæ¸²æŸ“
                if (currentPlayers.length > 0) {
                    currentPlayers = sortPlayers(currentPlayers);
                    renderPlayerCards();
                }
            }

            // é¡µé¢åˆå§‹åŒ–
            document.addEventListener('DOMContentLoaded', () => {
                // é¢„ç”Ÿæˆç©å®¶å¡ç‰‡
                preGeneratePlayerCards();

                // åˆå§‹åŒ–è¿æ¥
                initConnection();

                // é”®ç›˜å¿«æ·é”®
                document.addEventListener('keydown', (e) => {
                    switch (e.key.toLowerCase()) {
                        case '1':
                            setSortMode('hp');
                            break;
                        case '2':
                            setSortMode('name');
                            break;
                        case '3':
                            setSortMode('dps');
                            break;
                        case '4':
                            setSortMode('hps');
                            break;
                    }
                });
            });
        </script>
    </body>
</html>
